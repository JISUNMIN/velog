<p>라이브러리를 설치하려고 하던 중, 예상하지 못한 문제가 발생했습니다.<br />범인 찾기가 시작되었습니다.</p>
<hr />
<h1 id="💥-문제-상황">💥 문제 상황</h1>
<pre><code class="language-bash">pnpm add highlight.run @highlight-run/react</code></pre>
<p>실행과 동시에 다음과 같은 에러가 발생했습니다.
<img alt="" src="https://velog.velcdn.com/images/sunmins/post/1eea180a-0fed-46d7-b7bb-55c652aa8002/image.png" /></p>
<pre><code>ERR_PNPM_META_FETCH_FAIL GET http://172.32.3.142:4873/highlight.run
connect ETIMEDOUT 172.32.3.142:4873</code></pre><p>왜 제 패키지 요청이 사내 레지스트리(172.32.3.142)로 나가다가<br />타임아웃이 발생했는지 이해되지 않았습니다.</p>
<hr />
<h1 id="🔎-원인-분석">🔎 원인 분석</h1>
<h2 id="1-프로젝트-패키지-매니저를-여러-개-사용">1) 프로젝트 패키지 매니저를 여러 개 사용</h2>
<p>저는 평소에 <strong>pnpm</strong>을 선호하고 있어서 자연스럽게 pnpm을 사용하려 했습니다.<br />그런데 <strong>한 프로젝트에서는 여러 패키지 매니저를 동시에 사용하면 안 된다는 사실</strong>을 알게 되었습니다.<br />저는 개발자의 선호도에 따라 선택하는 문제라고만 생각하고 있었습니다.  </p>
<p>이 때문에 처음에는 <strong>“여러 패키지 매니저를 섞어 써서 문제가 생겼나?”</strong>라고 추측했습니다.</p>
<p>그래서 현재 프로젝트에서는 어떤 패키지 매니저를 쓰고 있는지 찾아보았습니다.<br />패키지 매니저는 lock 파일로 구분됩니다:</p>
<table>
<thead>
<tr>
<th>lock 파일</th>
<th>사용 패키지 매니저</th>
</tr>
</thead>
<tbody><tr>
<td>package-lock.json</td>
<td>npm</td>
</tr>
<tr>
<td>yarn.lock</td>
<td>yarn</td>
</tr>
<tr>
<td>pnpm-lock.yaml</td>
<td>pnpm</td>
</tr>
</tbody></table>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/7dc6a33c-dc50-47fa-819f-8ed44ef2ae1c/image.png" /></p>
<p>제 프로젝트에는 <code>yarn.lock</code>이 존재했고, yarn을 설치한 뒤<br /><code>yarn add highlight.run @highlight-run/react</code> 를 실행했습니다.<br />라이브러리는 잘 설치되었습니다.</p>
<p>그럼 yarn을 쓰고 있는데 pnpm으로 설치하려고 해서 에러가 난 걸까요?<br /><strong>그건 아니었습니다.</strong></p>
<hr />
<h2 id="2-npmrc의-사내-레지스트리-설정">2) <code>.npmrc</code>의 사내 레지스트리 설정</h2>
<p><code>.npmrc</code> 파일을 보니 registry가 다른 주소로 설정되어 있었습니다.</p>
<pre><code class="language-ini">registry=http://172.32.3.142:4873/</code></pre>
<p>yarn 명령어를 실행하기 전에<br />이 부분을 주석 처리하고 실행했기 때문에<br />원인이 패키지 때문인지, 해당 주소 설정 때문인지 명확히 알기 어려웠습니다.</p>
<p>그래서 <code>.npmrc</code>의 주석을 풀고 다른 라이브러리를 설치해 보았습니다.</p>
<pre><code class="language-bash">yarn add dayjs</code></pre>
<p>그러자 똑같은 에러가 나타났고,<br />원인은 패키지의 문제가 아닌 <strong><code>.npmrc</code> 설정 문제</strong>로 밝혀졌습니다.</p>
<h3 id="이유">이유</h3>
<p>npm과 pnpm은 <code>.npmrc</code> 설정을 그대로 따릅니다.</p>
<pre><code class="language-bash">npm config get registry
pnpm config get registry</code></pre>
<p>결과:</p>
<pre><code>registry=http://172.32.3.142:4873/</code></pre><p>즉, 설치 시도는 사내 레지스트리로 향했고,<br />그 서버에는 해당 라이브러리가 존재하지 않아 타임아웃 에러가 발생한 것입니다.</p>
<hr />
<h2 id="🤔-그런데-의문인-점">🤔 그런데 의문인 점?</h2>
<p>Yarn은 일반적으로 <code>.npmrc</code>를 직접 읽지 않는 것으로 알려져 있습니다.<br />그리고 실제로 아래 명령을 실행하면:</p>
<pre><code class="language-bash">yarn config get registry</code></pre>
<p>출력:</p>
<pre><code>https://registry.yarnpkg.com</code></pre><p>즉, Yarn은 공식 레지스트리를 바라보고 있는 것처럼 보였습니다.<br />그러나 실제 설치는 실패했습니다.</p>
<hr />
<h2 id="제-환경에서는-yarn도-npmrc의-영향을-받고-있었습니다">제 환경에서는 Yarn도 <code>.npmrc</code>의 영향을 받고 있었습니다</h2>
<p><code>.npmrc</code>가 존재하는 상태에서 다음 명령을 실행하면:</p>
<pre><code class="language-bash">yarn add dayjs</code></pre>
<p>→ 설치가 실패했습니다.</p>
<p>하지만 <code>.npmrc</code>의 레지스트리 설정을 주석 처리한 뒤:</p>
<pre><code class="language-ini"># registry=http://172.32.3.142:4873/</code></pre>
<p>다시 설치를 시도하니:</p>
<pre><code class="language-bash">yarn add dayjs</code></pre>
<p>→ 정상적으로 설치되었습니다.</p>
<p>즉,</p>
<blockquote>
<p>yarn config 출력과 실제 요청이 동일하지 않을 수 있으며,<br />Yarn v1은 특정 상황에서 <code>.npmrc</code>의 레지스트리 설정을 실제 요청에 반영할 수도 있다는 것을 확인했습니다.</p>
</blockquote>
<hr />
<h2 id="🤔-그런데-보통은-fallback이-되는-것-아닌가">🤔 그런데 보통은 fallback이 되는 것 아닌가?</h2>
<p>저는 이렇게 알고 있었습니다.</p>
<blockquote>
<p>“<code>.npmrc</code>에 레지스트리를 설정하면 <strong>먼저 사내 레지스트리를 보고</strong>,  
거기에 패키지가 없으면 <strong>공식 레지스트리로 자동 fallback</strong> 되겠지?”</p>
</blockquote>
<p>그러나 테스트 결과, <strong>제 환경에서는 fallback이 일어나지 않았습니다.</strong></p>
<ul>
<li>사내 레지스트리가 응답하지 않으면  </li>
<li>공식 레지스트리로 넘어가지 않고  </li>
<li>그대로 에러가 발생했습니다.</li>
</ul>
<p>즉,</p>
<blockquote>
<p><strong>“사내 레지스트리 → 실패 → 공식 레지스트리 fallback” 구조는 제 환경에서는 아니었습니다.</strong></p>
</blockquote>
<hr />
<p>일반적으로 기업 환경에서는 <strong>Proxy Repository</strong> 방식을 많이 사용합니다.</p>
<p>이 경우 구조는 다음과 같습니다:</p>
<pre><code>(개발자) → 사내 레지스트리 → (패키지 없음) → npmjs.org</code></pre><p>즉, 사내에 패키지가 없으면 자동으로 npmjs에서 가져오는 구조입니다.<br /><strong>fallback이 정상적으로 동작하는 환경입니다.</strong></p>
<p>하지만 해당 프로젝트의 레지스트리는 <strong>Hosted-only Repository</strong>였습니다.</p>
<pre><code>(개발자) → 사내 레지스트리 (패키지 없으면 즉시 실패)</code></pre><ul>
<li>npmjs로 넘기는 fallback 경로가 없고  </li>
<li>사내 레지스트리가 죽어 있으면  </li>
<li>npm, pnpm, yarn 모두 실패합니다  </li>
</ul>
<p>즉,</p>
<blockquote>
<p><strong>제 환경은 fallback이 없는 레지스트리 구조였기 때문에 발생한 문제였습니다.</strong></p>
</blockquote>
<p>이 부분은 이번 문제를 해결하면서 처음 알게 된 사실이었습니다.</p>
<hr />
<h1 id="해결-방법">해결 방법</h1>
<h2 id="1️⃣-npmrc의-사내-레지스트리-설정을-주석-처리했습니다">1️⃣ <code>.npmrc</code>의 사내 레지스트리 설정을 주석 처리했습니다</h2>
<pre><code class="language-ini"># registry=http://172.32.3.142:4873/</code></pre>
<h2 id="2️⃣-프로젝트-기준-패키지-매니저yarn를-사용했습니다">2️⃣ 프로젝트 기준 패키지 매니저(Yarn)를 사용했습니다</h2>
<pre><code class="language-bash">yarn add highlight.run @highlight-run/react</code></pre>
<h2 id="3️⃣-npm·pnpm도-정상적으로-공식-레지스트리를-사용하기-시작했습니다">3️⃣ npm·pnpm도 정상적으로 공식 레지스트리를 사용하기 시작했습니다</h2>
<p>사내 레지스트리 설정이 제거되면서<br />모든 패키지 매니저가 공식 npm 레지스트리로 요청을 보내게 되었습니다.</p>
<hr />
<h1 id="정리">정리</h1>
<ul>
<li><code>.npmrc</code>의 레지스트리 설정은 npm·pnpm뿐 아니라 Yarn v1에도 실제 영향을 줄 수 있었음.  </li>
<li>yarn config 출력만 보고 Yarn이 <code>.npmrc</code>를 무시한다고 판단할 수는 없었음.  </li>
<li>lock 파일을 기준으로 프로젝트 패키지 매니저를 통일해야 함.  </li>
<li>저는 fallback 구조라고 알고 있었으나, <strong>해당 프로젝트는 Hosted-only 레지스트리였기 때문에 fallback이 발생하지 않음.</strong>  </li>
<li><code>.npmrc</code> 주석 처리 후 Yarn으로 통일하자 모든 문제가 해결됨.  </li>
<li>하지만 라이브러리를 설치할 때마다 주석 처리를 반복할 수는 없으므로 Proxy Repository로 변경이 필요해 보임.<br />다만 Hosted-only로 설정해둔 데는 이유가 있을 수 있으므로 충분히 고려해야 함.</li>
</ul>