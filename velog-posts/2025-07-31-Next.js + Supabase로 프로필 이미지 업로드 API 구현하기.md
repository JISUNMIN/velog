í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì€ ë§ì€ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ë§ì´ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.

ì´ë²ˆ ê¸€ì—ì„œëŠ” **Next.js API Routeì—ì„œ Supabase Storageë¥¼ ì´ìš©í•´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³ ,  
ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ì˜ ê³µê°œ URLì„ ë°›ì•„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” APIë¥¼ ë‹¨ê³„ë³„ë¡œ êµ¬í˜„í•˜ëŠ” ë°©ë²•**ì„ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

**Supabase Storage ë²„í‚· ì„¸íŒ…ê³¼ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •ë° ì‚¬ìš©ë²•**ì— ëŒ€í•´ì„œëŠ” ì•„ë˜ ì‹œë¦¬ì¦ˆë¥¼ ì°¸ê³ í•´ ì£¼ì„¸ìš”.  
ğŸ“– [Supabase ì„¸íŒ… ê°€ì´ë“œ](https://velog.io/@sunmins/series/Supabase-%EC%84%B8%ED%8C%85-%EA%B0%80%EC%9D%B4%EB%93%9C)

---

## êµ¬í˜„í•œ ì½”ë“œ 

```ts
// route.ts
import { NextResponse } from "next/server";
import { supabase } from "@/lib/supabase";
import { prisma } from "@/lib/prisma";
import bcrypt from "bcrypt";

export async function PATCH(
  req: Request,
  context: { params: Promise<{ userId: string }> }
) {
  try {
    const formData = await req.formData();
    const file = formData.get("profileImage") as File | null;
    const password = formData.get("password") as string | null;
    const { userId } = await context.params;

    // ì—…ë°ì´íŠ¸í•  ë°ì´í„° ê°ì²´ ì´ˆê¸°í™”
    const updateData: { profileImage?: string; password?: string } = {};

    // 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
    if (file && file.size > 0) {
      // íŒŒì¼ í™•ì¥ì ì¶”ì¶œ
      const fileExt = file.name.split(".").pop();
      // ê³ ìœ  íŒŒì¼ëª… ìƒì„± (ìœ ì €ID + íƒ€ì„ìŠ¤íƒ¬í”„)
      const fileName = `${userId}_${Date.now()}.${fileExt}`;

      // Supabase Storageì— íŒŒì¼ ì—…ë¡œë“œ
      const { error: uploadError } = await supabase.storage
        .from("profile-images")
        .upload(fileName, file, {
          cacheControl: "3600", 
          upsert: true, // default: false (ê°™ì€ íŒŒì¼ëª…ì´ ìˆì„ë•Œ ë®ì–´ ì“°ì§€ ì•ŠìŒ, falseì¼ ê²½ìš° íŒŒì¼ëª…ì´ ì¤‘ë³µë˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.)
        });

      if (uploadError) {
        console.error(uploadError);
        return NextResponse.json(
          { error: "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨" },
          { status: 500 }
        );
      }

      // ì—…ë¡œë“œí•œ íŒŒì¼ì˜ ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
      const {
        data: { publicUrl },
      } = supabase.storage.from("profile-images").getPublicUrl(fileName);

      // ì—…ë°ì´íŠ¸ ë°ì´í„°ì— publicUrl ì €ì¥
      updateData.profileImage = publicUrl;
    }

    // 2. ë¹„ë°€ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•´ì‹± í›„ ì—…ë°ì´íŠ¸ ë°ì´í„°ì— í¬í•¨
    if (password) {
      const hashedPassword = await bcrypt.hash(password, 10);
      updateData.password = hashedPassword;
    }

    // ë³€ê²½í•  ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°˜í™˜
    if (Object.keys(updateData).length === 0) {
      return NextResponse.json(
        { error: "ë³€ê²½í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." },
        { status: 400 }
      );
    }

    // 3. DBì—ì„œ ìœ ì € ì •ë³´ ì—…ë°ì´íŠ¸
    const updatedUser = await prisma.user.update({
      where: { id: Number(userId) },
      data: updateData,
      select: {
        id: true,
        userId: true,
        name: true,
        profileImage: true,
      },
    });

    // ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ëœ ìœ ì € ì •ë³´ ë°˜í™˜
    return NextResponse.json(updatedUser);
  } catch (error) {
    console.error("PATCH /api/users/profile ì—ëŸ¬:", error);
    return NextResponse.json(
      { error: "í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." },
      { status: 500 }
    );
  }
}
```

## ì½”ë“œ ì„¤ëª…

### 1. formDataì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°

```ts
const formData = await req.formData();
const file = formData.get("profileImage") as File | null;
const password = formData.get("password") as string | null;
const { userId } = await context.params;
```

- í´ë¼ì´ì–¸íŠ¸ì—ì„œ `ë©€í‹°íŒŒíŠ¸(formData) í˜•ì‹`ìœ¼ë¡œ ë³´ë‚¸ ì´ë¯¸ì§€ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.
- userIdëŠ” URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ë°›ì•„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.
---

### 2. Supabase ìŠ¤í† ë¦¬ì§€ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ

```ts
if (file && file.size > 0) {
  const fileExt = file.name.split(".").pop();
  const fileName = `${userId}_${Date.now()}.${fileExt}`;

  const { error: uploadError } = await supabase.storage
    .from("profile-images") // 'profile-images'ëŠ” ë²„í‚·(bucket) ì´ë¦„ì…ë‹ˆë‹¤.
    .upload(fileName, file, {
      cacheControl: "3600", // ìºì‹œ ìœ ì§€ ì‹œê°„(ì´ˆ) ì„¤ì •
      upsert: true,  // ê°™ì€ ì´ë¦„ íŒŒì¼ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸° ì—¬ë¶€
    });

  if (uploadError) {
    // ì—ëŸ¬ ì²˜ë¦¬
  }

  const {
    data: { publicUrl },
  } = supabase.storage.from("profile-images").getPublicUrl(fileName);

  updateData.profileImage = publicUrl;
}
```

- íŒŒì¼ëª…ì´ ê²¹ì¹˜ì§€ ì•Šë„ë¡ userIdì™€ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì¡°í•©í•´ ê³ ìœ  íŒŒì¼ëª…ì„ ë§Œë“­ë‹ˆë‹¤.
- Supabase ìŠ¤í† ë¦¬ì§€ì— ì—…ë¡œë“œí•˜ê³ , ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
- ì„±ê³µí•˜ë©´ `ê³µê°œ URL`ì„ ë°›ì•„ `updateData`ì— ì €ì¥í•©ë‹ˆë‹¤.

---

### âœš `upload()` ë©”ì„œë“œì™€ ë°˜í™˜ê°’

`upload()` ë©”ì„œë“œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì„¸ ê°œì˜ ì¸ìë¥¼ ë°›ìŠµë‹ˆë‹¤:

- **íŒŒì¼ëª… (fileName)**: ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•  ë•Œ ì‚¬ìš©í•  ì´ë¦„ì…ë‹ˆë‹¤.
- **íŒŒì¼ ê°ì²´ (file)**: ì‹¤ì œ ì—…ë¡œë“œí•  íŒŒì¼ì…ë‹ˆë‹¤.
- **ì˜µì…˜ ê°ì²´**: ì—…ë¡œë“œ ì‹œ ì„¤ì •í•  ì˜µì…˜ë“¤ (ì˜ˆ: ìºì‹œ ì„¤ì •, ë®ì–´ì“°ê¸° ì—¬ë¶€ ë“±)


### ë°˜í™˜ê°’ êµ¬ì¡°ì™€ ì˜ˆì‹œ

```ts
{
  data: {
    Key: string;        // ì €ì¥ëœ íŒŒì¼ì˜ ì „ì²´ ê²½ë¡œ (ë²„í‚· ë‚´ ê²½ë¡œ í¬í•¨)
    KeyMetadata?: any;  // (ì„ íƒì ) ë©”íƒ€ë°ì´í„° ì •ë³´
  } | null,
  error: Error | null   // ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ê°ì²´
}
  
// ì˜ˆì‹œ
  {
  data: {
    Key: "profile-images/user123_1680000000000.png"
  },
  error: null
}
```
- `data.Key`: ì—…ë¡œë“œëœ íŒŒì¼ì´ ì €ì¥ëœ ìŠ¤í† ë¦¬ì§€ ë‚´ ê²½ë¡œì™€ íŒŒì¼ ì´ë¦„ì…ë‹ˆë‹¤.
- `data.KeyMetadata`: (ìˆì„ ê²½ìš°) íŒŒì¼ì— ëŒ€í•œ ì¶”ê°€ ë©”íƒ€ë°ì´í„° ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
- `error`: ì—…ë¡œë“œ ê³¼ì •ì—ì„œ ë°œìƒí•œ ì—ëŸ¬ê°€ ìˆì„ ê²½ìš° í•´ë‹¹ ì—ëŸ¬ ê°ì²´ê°€ ë‹´ê¹ë‹ˆë‹¤. ì„±ê³µ ì‹œ nullì…ë‹ˆë‹¤.



---
  

### 3.Prismaë¥¼ ì´ìš©í•´ DB ì—…ë°ì´íŠ¸
```ts
const updatedUser = await prisma.user.update({
  where: { id: Number(userId) },
  data: updateData,
  select: {
    id: true,
    userId: true,
    name: true,
    profileImage: true,
  },
});
```

## ğŸ“ ë§ˆë¬´ë¦¬
Next.js API Routeì—ì„œ Supabase Storageë¥¼ í™œìš©í•´ ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ì²˜ë¦¬í•˜ê³ , ê³µê°œ URLì„ ë°›ì•„ ì‚¬ìš©ì í”„ë¡œí•„ì— ë°˜ì˜í•˜ëŠ” ê³¼ì •ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.
ì´ ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ì í”„ë¡œí•„ í¸ì§‘ ê¸°ëŠ¥ì„ ê°„ë‹¨íˆ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.