<p>요새 어디에나 있는 sns로그인<br />그중에서도 <strong>카카오 로그인 하는법</strong>을 정리했습니다.<br />또한 제가 헤멘곳은 남들도 헤메는법… <strong>헤멘곳 위주로 정리해보겠습니다.</strong></p>
<p>어떤 프레임워크를 쓰는지에 따라 방법이 다를수 있습니다.<br />저는 <strong>next + prisma + supabase</strong> 조합을 쓰고있기떄문에<br /><strong>next/auth</strong>와 <strong>prisma adaptor</strong>를 통해 db에 저장했습니다.  </p>
<p>시작 해보겠습니다. 렛츠고~</p>
<hr />
<h2 id="1-카카오-디벨로퍼-가입-및-설정">1) 카카오 디벨로퍼 가입 및 설정</h2>
<h3 id="1-카카오-디벨로퍼-가입">1) 카카오 디벨로퍼 가입</h3>
<p>카카오 디벨로퍼에 접속하여 회원가입을 해줍니다.</p>
<p><a href="https://developers.kakao.com/">https://developers.kakao.com/</a></p>
<hr />
<h3 id="2-앱-생성하기">2) 앱 생성하기</h3>
<p>앱탭으로 들어가서 앱을 생성합니다.</p>
<ul>
<li>회사명은 전 개인이라고 적어줬습니다.</li>
<li>앱이 생성되면 클릭하여 들어갑니다.</li>
</ul>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/35325dd8-4c8c-4bfe-9440-f166994a6851/image.png" /></p>
<hr />
<h3 id="3-카카오-로그인-설정-on">3) 카카오 로그인 설정 (ON)</h3>
<p>좌측 메뉴에서:</p>
<p><strong>제품설정 → 카카오 로그인 → 일반</strong></p>
<p>여기서 아래 설정을 ON 해줍니다.</p>
<ul>
<li>사용설정 ON</li>
<li>OpenId connect ON</li>
</ul>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/21516007-e47e-4c46-a411-5e4c56725593/image.png" /></p>
<hr />
<h3 id="4-env에-clientid--clientsecret-넣기">4) .env에 clientId / clientSecret 넣기</h3>
<p>.env에 <code>clientId</code>와 <code>clientSecret</code>이 필요한데 각각 아래처럼 가져옵니다.</p>
<h4 id="clientid-가져오기">clientId 가져오기</h4>
<p><strong>앱 → 플랫폼키 → REST API 키</strong> 복사합니다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/5822aad9-6a80-47fa-b83e-0950739f9a57/image.png" /></p>
<hr />
<h4 id="clientsecret-가져오기">clientSecret 가져오기</h4>
<p><strong>앱 → 플랫폼키 → REST API 클릭 → 카카오 로그인 코드 복사</strong></p>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/595c0dde-3e17-4be9-bf97-3790fdbcdf36/image.png" /></p>
<hr />
<h3 id="5-env-파일-작성">5) .env 파일 작성</h3>
<p>.env 파일에 key들을 추가해줍니다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/43cfe4c5-9993-4a6b-869f-3e6a69dd9f6d/image.png" /></p>
<p>예시:</p>
<pre><code class="language-env">KAKAO_CLIENT_ID=xxxxx
KAKAO_CLIENT_SECRET=xxxxx</code></pre>
<p>일단 여기까지하면 기본설정은 끝났습니다.
추후 필요한 설정은 뒤쪽에서 알아보겠습니다</p>
<hr />
<h2 id="2-nextauthjs-세팅-및-사용법">2) NextAuth.js 세팅 및 사용법</h2>
<p>NextAuth 공식 문서입니다.</p>
<p><a href="https://next-auth.js.org/">https://next-auth.js.org/</a></p>
<h3 id="next-auth-docs에서-get-started-따라하기">Next-auth docs에서 Get Started 따라하기</h3>
<h3 id="1-라이브러리-설치">1) 라이브러리 설치</h3>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/e31063eb-3656-4560-adb2-856270b28225/image.png" /></p>
<hr />
<h3 id="2-nextauth-파일-생성">2) nextauth 파일 생성</h3>
<p><code>page/api/auth/[...nextauth].js</code> 경로로 해당 파일을 생성합니다.
App router의 경우는  <code>src/app/api/auth/[...nextauth]/route.ts</code> 으로 생성합니다.</p>
<blockquote>
<p><code>[...nextauth]</code>는 <strong>NextAuth가 <code>/api/auth/*</code> 경로로 들어오는 다양한 요청을 한 번에 처리하기 위해 쓰는 Catch-all 라우팅 문법</strong>입니다.<br />즉 로그인, 콜백, 세션 확인 같은 여러 요청을 이 한 파일에서 다 받아서 처리해줍니다.</p>
</blockquote>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/38bd62ef-ef7b-4f3e-93e7-1ee574d1f2b1/image.png" /></p>
<hr />
<h3 id="3-sessionprovider로-감싸기">3) SessionProvider로 감싸기</h3>
<p>SessionProvider로 감싸줘야 안쪽에서 session을 감지 할수있습니다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/4a345173-bf71-484c-b53c-81da13e7429a/image.png" /></p>
<p>화면 컴포넌트에서는 <code>useSession()</code> 함수를 통해 session을 받아올수있습니다.
<img alt="" src="https://velog.velcdn.com/images/sunmins/post/5bc97e39-5f9f-4c99-9fb2-8fcb03e1335b/image.png" /></p>
<hr />
<h2 id="3-구현-코드">3) 구현 코드</h2>
<h3 id="authts">auth.ts</h3>
<pre><code class="language-ts">// auth.ts
import NextAuth from &quot;next-auth&quot;;
import { PrismaAdapter } from &quot;@auth/prisma-adapter&quot;;
import { prisma } from &quot;@/lib/prisma&quot;;
import KakaoProvider from &quot;next-auth/providers/kakao&quot;;

export const { handlers, signIn, signOut, auth } = NextAuth({
  // 해당 adaptoer는 prisma와 연결해주는 어댑터로 받아온 데이터를 prisma에 자동저장해줍니다.
  // 물론 자동저장해주려면 db의 이름과 구조는 동일하게 설정해야합니다. 이건 다음글에서 알아보겠습니다.
  adapter: PrismaAdapter(prisma),

  session: { strategy: &quot;jwt&quot; },
  providers: [
    // 일반 로그인
    Credentials: ({
      ...
    }),
    KakaoProvider({
      // 기본적으로 clientId,clientSecret는 필수입니다.
      // authorization은 뒤에서 알아보겠습니다.
      clientId: process.env.KAKAO_CLIENT_ID!,
      clientSecret: process.env.KAKAO_CLIENT_SECRET!,
      authorization: {
        url: &quot;https://kauth.kakao.com/oauth/authorize&quot;,
        // 회원가입시 받아올 유저정보
        params: { prompt: &quot;login&quot;, scope: &quot;profile_nickname&quot; },
      },
    }),
  ],
  callbacks: {
  // 로그인/로그아웃 후 이동할 URL(리다이렉트 경로)을 제어하는 설정입니다.
    async redirect({ url, baseUrl }) {
      if (url.startsWith(&quot;/&quot;)) return `${baseUrl}${url}`;
      if (new URL(url).origin === baseUrl) return url;
      return baseUrl;
    },
  },
});</code></pre>
<hr />
<h3 id="routets">route.ts</h3>
<pre><code class="language-ts">// src/app/api/auth/[...nextauth]/route.ts
import { handlers } from &quot;~/auth&quot;;
export const { GET, POST } = handlers;</code></pre>
<p>이 파일은 <strong>NextAuth가 동작할 API 엔드포인트(<code>/api/auth/*</code>)를 연결해주는 라우트 파일</strong>입니다.</p>
<p>쉽게 말하면,</p>
<ul>
<li><code>~/auth</code>에 있는 NextAuth 설정(auth.ts)을 가져오고  </li>
<li>Next.js App Router 방식에서 필요한 <code>GET</code>, <code>POST</code> 요청을 export 해서  </li>
<li><strong>카카오 로그인 요청 / 콜백 처리 / 세션 확인 같은 인증 흐름이 여기서 동작하게 해주는 역할</strong>입니다.  </li>
</ul>
<p>즉, 이 파일이 없으면 <code>signIn()</code> 같은걸 호출해도<br />서버에서 인증을 처리할 주소가 없어서 로그인 자체가 안됩니다.</p>
<hr />
<h3 id="layout에서-session-내려주기">layout에서 session 내려주기</h3>
<pre><code class="language-ts">// src/app/layout

import { auth } from &quot;~/auth&quot;;
import SessionProvider from &quot;@/providers/SessionProvider&quot;;

export default async function RootLayout({ children }: { children: React.ReactNode }) {
  const session = await auth();

  return (
    &lt;SessionProvider session={session}&gt;
      &lt;TranslationProvider&gt;
        &lt;QueryProvider&gt;
          &lt;I18nProvider&gt;
            &lt;div className=&quot;flex min-h-screen flex-col items-center&quot;&gt;
              &lt;Header /&gt;
              &lt;main className=&quot;flex-1 w-full max-w-6xl px-4&quot;&gt;{children}&lt;/main&gt;
            &lt;/div&gt;
            &lt;ClientLayout /&gt;
            &lt;Toaster /&gt;
          &lt;/I18nProvider&gt;
        &lt;/QueryProvider&gt;
      &lt;/TranslationProvider&gt;
    &lt;/SessionProvider&gt;
  );
}</code></pre>
<p>SessionProvider로 감싸고 sesion을 내려줍니다.</p>
<hr />
<h3 id="sessionprovider-분리">SessionProvider 분리</h3>
<pre><code class="language-ts">// app/providers/SessionProvider.tsx

&quot;use client&quot;;
import { SessionProvider as AuthSessionProvider, SessionProviderProps } from &quot;next-auth/react&quot;;

export default function SessionProvider({ children, session }: SessionProviderProps) {
  return &lt;AuthSessionProvider session={session}&gt;{children}&lt;/AuthSessionProvider&gt;;
}</code></pre>
<p>SessionProvider은 기본적으로 client컴포넌트이기떄문에 유지보수를 생각하여 클라이언트 컴포넌트로 분리했습니다.</p>
<hr />
<h3 id="sns-로그인-버튼">SNS 로그인 버튼</h3>
<pre><code class="language-ts">// components/common/SNSButton.tsx
&quot;use client&quot;;

import { Button } from &quot;@/components/ui/button&quot;;
import { cn } from &quot;@/lib/utils&quot;;
import { SNSType } from &quot;@/types&quot;;
import { signIn } from &quot;next-auth/react&quot;;
import Image from &quot;next/image&quot;;
import { useTranslation } from &quot;react-i18next&quot;;

export default function SNSButton({ type, hasLabel = false, className }: SNSButtonProps) {
  const handleSNSSignup = async () =&gt; {
    if (type === &quot;kakao&quot;) {
      const res = await signIn(type, {
        callbackUrl: &quot;/&quot;,
      });
    }
  };

  if (type === &quot;kakao&quot;) {
    return (
      &lt;Button
        variant=&quot;outline&quot;
        type=&quot;button&quot;
        className={cn(&quot;w-full hover:bg-yellow-50&quot;, className)}
        aria-label={ariaLabel}
        onClick={handleSNSSignup}
      /&gt;
    );
  }
}</code></pre>
<p>SNS 로그인 버튼입니다.<br /><code>next-auth/react</code>의 <code>signIn</code> 함수를 호출하여 로그인합니다.</p>
<hr />
<h3 id="로그아웃-버튼">로그아웃 버튼</h3>
<pre><code class="language-ts">&quot;use client&quot;;

import { signOut } from &quot;next-auth/react&quot;;
import { Button } from &quot;../ui/button&quot;;
import { useState } from &quot;react&quot;;

export function LogoutButton() {
  const [isLoggingOut, setIsLoggingOut] = useState(false);

  const handleLogout = async () =&gt; {
    setIsLoggingOut(true);
    await signOut({ callbackUrl: &quot;/&quot; });
  };

  return (
    &lt;Button
      type=&quot;button&quot;
      variant=&quot;ghost&quot;
      size=&quot;sm&quot;
      className=&quot;px-2 flex items-center gap-1&quot;
      onClick={handleLogout}
      disabled={isLoggingOut}
    /&gt;
  );
}</code></pre>
<p>로그아웃 버튼입니다.<br /><code>next-auth/react</code>의 <code>signOut</code> 함수를 호출하여 로그아웃합니다.</p>
<hr />
<h2 id="4-구현-중-발생한-에러">4) 구현 중 발생한 에러</h2>
<p>auth.json에서 provider의 설정을 수정할수있는데 여기서 에러가 많이 발생했습니다.<br />케이스를 정리해보겠씁니다.</p>
<h3 id="에러-정리용-코드">에러 정리용 코드</h3>
<pre><code class="language-ts">// auth.ts
import NextAuth from &quot;next-auth&quot;;
import { PrismaAdapter } from &quot;@auth/prisma-adapter&quot;;
import { prisma } from &quot;@/lib/prisma&quot;;
import KakaoProvider from &quot;next-auth/providers/kakao&quot;;

export const { handlers, signIn, signOut, auth } = NextAuth({
  adapter: PrismaAdapter(prisma),
  session: { strategy: &quot;jwt&quot; }, // 1번
  providers: [
    Credentials: ({
      ...
    }),
    KakaoProvider({
      clientId: process.env.KAKAO_CLIENT_ID!,
      clientSecret: process.env.KAKAO_CLIENT_SECRET!,
      // 2번
      authorization: {
        url: &quot;https://kauth.kakao.com/oauth/authorize&quot;,
        params: { prompt: &quot;login&quot;, scope: &quot;profile_nickname&quot; },
      },
    }),
  ],
  callbacks: {
    async redirect({ url, baseUrl }) {
      if (url.startsWith(&quot;/&quot;)) return `${baseUrl}${url}`;
      if (new URL(url).origin === baseUrl) return url;
      return baseUrl;
    },
  },
});</code></pre>
<hr />
<h3 id="1번---session-undefined-되는-버그">1번 - session undefined 되는 버그</h3>
<p>nextauth의 기본 세션전략은 jwt와 db세션입니다.<br />default는 jwt이나 저는 일반 로그인도 auth에서 관리하려고 추후에 설정했는데,</p>
<p><strong>Credentials(일반로그인) + PrismaAdaptor가 합쳐지니 session값이 undefined가 되는 버그가 발생</strong>하여<br />명시하여 해결했습니다.</p>
<pre><code class="language-ts">session: { strategy: &quot;jwt&quot; },</code></pre>
<hr />
<h3 id="2번---로그아웃-후에도-자동로그인-되는-문제">2번 - 로그아웃 후에도 자동로그인 되는 문제</h3>
<p>카카오 로그인의 기본동작은 로그인을 한번이라도 했다면<br />다시 로그인을 클릭했을때는 자동로그인이 되는것 같았습니다.</p>
<p>하지만 저는 로그아웃 후 로그인시 항상 아이디와 비밀번호를 다시 받기를 구상하여<br />authorization의 params prompt에 <code>login</code> 옵션을 주었습니다.</p>
<pre><code class="language-ts">authorization: {
  url: &quot;https://kauth.kakao.com/oauth/authorize&quot;,
  params: { prompt: &quot;login&quot;, scope: &quot;profile_nickname&quot; },
},</code></pre>
<p>그 결과는...</p>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/b5ec8182-b6fd-41f7-ac0b-6f7d852a3cbb/image.png" /></p>
<p>이런 화면을 계속 보게되었습니다.</p>
<hr />
<h4 id="원인">원인</h4>
<p><code>profile_nickname</code>를 받아오려고 하면서<br />설정은 되어있지 않기 떄문이었습니다.</p>
<hr />
<h4 id="해결-방법-동의항목-설정">해결 방법 (동의항목 설정)</h4>
<p>카카오 디벨로퍼를 들어가서:</p>
<p><strong>카카오 로그인 → 동의항목 → 개인정보</strong></p>
<p>여기서 필요한 항목을 동의합니다.<br />제 경우 <code>profile_nickname</code> 즉 닉네임이 필요했기떄문에 동의설정을 하였습니다.</p>
<p><img alt="" src="https://velog.velcdn.com/images/sunmins/post/631e3f76-f13a-4f10-b33e-7eec60421ee1/image.png" /></p>
<hr />
<h4 id="추가로-해결된-부분">추가로 해결된 부분</h4>
<p>또한 authorization 없을때는 에러가 발생하지않았지만,<br />authorization를 설정한 후에는 계속 에러가 떠서</p>
<p><strong>url을 명시적으로 적어주니 에러가 발생하지 않았습니다.</strong></p>
<hr />
<h2 id="마무리">마무리</h2>
<p>이번 글에서는 <strong>카카오톡 디벨로퍼 설정</strong>과 <strong>next/auth를 통한 구현방법</strong>을 알아봤습니다.  </p>
<p>다음 글에서는  </p>
<ul>
<li>prisma adaptor 연결을 위한 db model 정의  </li>
<li>카카오톡 로그인은 기본적으로 페이지를 이동하게되는데, 팝업을 띄워서 로그인하는법  </li>
</ul>
<p>을 알아보겠습니다.</p>